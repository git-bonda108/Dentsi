// This is your Prisma schema file
// DENTSI - AI Voice Agent for Dental Appointment Automation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CLINIC MANAGEMENT
// =============================================================================

model clinic {
  id           String        @id @default(uuid())
  name         String
  phone        String
  address      String
  hours        String        // JSON string: {"mon": "9-5", "tue": "9-5"...}
  timezone     String        @default("America/New_York")
  is_active    Boolean       @default(true)
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  
  // Relations
  appointments       appointment[]
  calls              call[]
  services           service[]
  doctors            doctor[]
  patients           patient[]
  conversation_scripts conversation_script[]
  outbound_calls     outbound_call[]
}

// =============================================================================
// DOCTOR MANAGEMENT
// =============================================================================

model doctor {
  id               String   @id @default(uuid())
  clinic_id        String
  name             String
  specialty        String   @default("General Dentistry") // General Dentistry, Orthodontics, Oral Surgery, etc.
  phone            String?
  email            String?
  available_hours  String?  // JSON string: {"mon": ["9:00-12:00", "14:00-17:00"], ...}
  bio              String?  @db.Text
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  
  // Relations
  clinic                  clinic        @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  appointments            appointment[]
  preferred_by_patients   patient[]     @relation("PreferredDoctor")

  @@index([clinic_id])
  @@index([specialty])
}

// =============================================================================
// PATIENT MANAGEMENT (Enhanced with history tracking)
// =============================================================================

model patient {
  id                  String    @id @default(uuid())
  clinic_id           String
  name                String
  phone               String    @unique
  email               String?
  date_of_birth       DateTime?
  
  // Insurance Information
  insurance_provider  String?   // e.g., "Delta Dental", "Cigna"
  insurance_id        String?   // Policy/Member ID
  insurance_group     String?   // Group number
  insurance_verified  Boolean   @default(false)
  insurance_verified_at DateTime?
  insurance_info      String?   @db.Text // Legacy JSON field for additional insurance data
  
  // Medical History
  medical_history     String?   @db.Text // JSON: {"allergies": [], "medications": [], "conditions": []}
  dental_history      String?   @db.Text // JSON: {"last_cleaning": "2025-06-01", "treatments": [...]}
  notes               String?   @db.Text // Staff notes about patient
  
  // Preferences
  preferred_doctor_id String?
  preferred_time      String?   // "morning", "afternoon", "evening"
  preferred_days      String?   // JSON: ["Monday", "Wednesday", "Friday"]
  communication_pref  String    @default("phone") // phone, sms, email
  language            String    @default("en") // en, es, etc.
  
  // Tracking
  last_visit_date     DateTime?
  next_recall_date    DateTime? // When to remind for next cleaning
  no_show_count       Int       @default(0)
  total_visits        Int       @default(0)
  
  // Status
  is_active           Boolean   @default(true)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  // Relations
  clinic              clinic        @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  preferred_doctor    doctor?       @relation("PreferredDoctor", fields: [preferred_doctor_id], references: [id], onDelete: SetNull)
  appointments        appointment[]
  calls               call[]
  conversation_logs   conversation_log[]
  outbound_calls      outbound_call[]

  @@index([clinic_id])
  @@index([phone])
  @@index([preferred_doctor_id])
  @@index([last_visit_date])
}

// =============================================================================
// APPOINTMENT MANAGEMENT (Enhanced with doctor assignment)
// =============================================================================

model appointment {
  id               String   @id @default(uuid())
  clinic_id        String
  patient_id       String?
  doctor_id        String?
  call_id          String?
  
  // Appointment Details
  appointment_date DateTime
  start_time       String?  // "09:00", "14:30" etc.
  duration_minutes Int      @default(60)
  service_type     String
  reason           String?  @db.Text // Patient's stated reason
  
  // Status tracking
  status           String   @default("scheduled") // scheduled, confirmed, completed, cancelled, no-show, rescheduled
  confirmed_at     DateTime?
  completed_at     DateTime?
  cancelled_at     DateTime?
  cancellation_reason String?
  
  // Notes
  notes            String?  @db.Text
  staff_notes      String?  @db.Text
  
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  
  // Relations
  clinic           clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  patient          patient? @relation(fields: [patient_id], references: [id], onDelete: SetNull)
  doctor           doctor?  @relation(fields: [doctor_id], references: [id], onDelete: SetNull)
  call             call?    @relation(fields: [call_id], references: [id], onDelete: SetNull)
  outbound_calls   outbound_call[]

  @@index([clinic_id])
  @@index([patient_id])
  @@index([doctor_id])
  @@index([call_id])
  @@index([appointment_date])
  @@index([status])
}

// =============================================================================
// CALL MANAGEMENT (Enhanced for ML training)
// =============================================================================

model call {
  id              String    @id @default(uuid())
  clinic_id       String
  patient_id      String?
  call_sid        String    @unique
  caller_phone    String?   // Incoming phone number
  
  // Conversation
  transcript      String?   @db.Text
  intent          String?   // new_appointment, reschedule, cancel, emergency, inquiry
  sub_intent      String?   // More specific intent classification
  
  // Call metrics
  duration        Int?      // in seconds
  talk_time       Int?      // actual speaking time
  hold_time       Int?      // time on hold
  
  // Outcome tracking
  status          String    @default("in_progress") // in_progress, completed, failed, escalated
  outcome         String?   // booked, rescheduled, cancelled, info_provided, escalated, dropped
  
  // Quality metrics (for ML training)
  sentiment_score Float?    // -1 to 1 sentiment analysis
  satisfaction_score Int?   // 1-5 if collected
  quality_rating  Int?      // Staff quality rating 1-5
  quality_notes   String?   @db.Text
  
  // Technical
  audio_url       String?   // URL to call recording
  metadata        String?   @db.Text // JSON string for additional data
  error_log       String?   @db.Text // Any errors during call
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relations
  clinic          clinic        @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  patient         patient?      @relation(fields: [patient_id], references: [id], onDelete: SetNull)
  appointments    appointment[]
  conversation_logs conversation_log[]

  @@index([clinic_id])
  @@index([patient_id])
  @@index([call_sid])
  @@index([caller_phone])
  @@index([created_at])
  @@index([outcome])
}

// =============================================================================
// SERVICE CATALOG
// =============================================================================

model service {
  id               String   @id @default(uuid())
  clinic_id        String
  service_name     String
  description      String?  @db.Text
  duration_minutes Int
  price            Float
  category         String   @default("general") // general, cosmetic, emergency, preventive
  is_active        Boolean  @default(true)
  
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  
  clinic           clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)

  @@index([clinic_id])
  @@index([category])
}

// =============================================================================
// CONVERSATION SCRIPTS (Natural language templates per clinic)
// =============================================================================

model conversation_script {
  id          String   @id @default(uuid())
  clinic_id   String
  
  // Script identification
  name        String   // "Default Greeting", "Returning Patient", "Emergency", etc.
  type        String   // greeting, booking_flow, insurance, doctor_preference, farewell, error_recovery
  language    String   @default("en")
  
  // The actual script/prompt
  script_content String @db.Text // The natural language script template
  system_prompt  String? @db.Text // OpenAI system prompt for this context
  
  // Variables that can be injected
  variables   String?  @db.Text // JSON: ["patient_name", "clinic_name", "last_visit", ...]
  
  // Conditions
  conditions  String?  @db.Text // JSON: {"patient_type": "returning", "time_of_day": "morning"}
  priority    Int      @default(0) // Higher priority scripts are used first
  
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  clinic      clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)

  @@index([clinic_id])
  @@index([type])
  @@index([language])
}

// =============================================================================
// ML TRAINING: CONVERSATION LOGS
// =============================================================================

model conversation_log {
  id          String   @id @default(uuid())
  call_id     String?
  patient_id  String?
  
  // Conversation turn
  turn_number Int
  role        String   // user, assistant, system
  content     String   @db.Text
  
  // Analysis
  intent_detected     String?
  entities_extracted  String?  @db.Text // JSON: {"date": "...", "time": "...", "service": "..."}
  confidence_score    Float?
  
  // Timing
  response_time_ms    Int?     // How long AI took to respond
  
  // Training flags
  marked_for_training Boolean  @default(false)
  training_label      String?  // Correct response label for training
  
  created_at  DateTime @default(now())
  
  // Relations
  call        call?    @relation(fields: [call_id], references: [id], onDelete: SetNull)
  patient     patient? @relation(fields: [patient_id], references: [id], onDelete: SetNull)

  @@index([call_id])
  @@index([patient_id])
  @@index([marked_for_training])
  @@index([created_at])
}

// =============================================================================
// ESCALATIONS
// =============================================================================

model escalation {
  id          String   @id @default(uuid())
  call_id     String?
  clinic_id   String
  
  // Escalation details
  type        String   // emergency, complex_request, complaint, technical_issue, human_requested
  priority    String   @default("medium") // low, medium, high, critical
  reason      String   @db.Text
  
  // Context
  conversation_summary String? @db.Text
  patient_info        String?  @db.Text // JSON
  
  // Resolution
  status      String   @default("open") // open, in_progress, resolved, closed
  assigned_to String?
  resolved_by String?
  resolution  String?  @db.Text
  resolved_at DateTime?
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([clinic_id])
  @@index([status])
  @@index([priority])
  @@index([created_at])
}

// =============================================================================
// FEEDBACK & ML TRAINING
// =============================================================================

model feedback {
  id                 String   @id @default(uuid())
  call_id            String
  clinic_id          String
  
  // Feedback type
  type               String   // quality_rating, response_rating, correction, escalation_review, patient_survey, staff_annotation
  
  // Rating (1-5 scale)
  rating             Int?
  
  // For corrections - specific turn
  turn_number        Int?
  original_response  String?  @db.Text
  corrected_response String?  @db.Text
  
  // Additional context
  notes              String?  @db.Text
  tags               String?  @db.Text // JSON array of tags
  
  // Who submitted
  submitted_by       String   // staff_id, 'patient', or 'system'
  
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([call_id])
  @@index([clinic_id])
  @@index([type])
  @@index([created_at])
}

// =============================================================================
// ML MODEL TRACKING
// =============================================================================

model ml_model {
  id               String   @id @default(uuid())
  clinic_id        String?  // null = global model
  
  // Model info
  name             String   // e.g., "dentra-v1.2-clinic-abc"
  base_model       String   // e.g., "gpt-4o-mini"
  fine_tuned_id    String?  // OpenAI fine-tuned model ID
  
  // Training data
  training_file    String?  // Path to training JSONL
  examples_count   Int      @default(0)
  tokens_count     Int      @default(0)
  
  // Performance metrics
  accuracy         Float?
  avg_quality      Float?
  booking_rate     Float?
  
  // Status
  status           String   @default("pending") // pending, training, ready, active, deprecated
  is_active        Boolean  @default(false)
  
  // Timestamps
  trained_at       DateTime?
  deployed_at      DateTime?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([clinic_id])
  @@index([status])
  @@index([is_active])
}

// =============================================================================
// OUTBOUND CALLS
// =============================================================================

model outbound_call {
  id              String   @id @default(uuid())
  clinic_id       String
  patient_id      String
  appointment_id  String?
  call_sid        String?  @unique // Twilio call SID
  
  // Call type
  call_type       String   // appointment_reminder, appointment_confirmation, follow_up, recall, no_show_reschedule, custom
  
  // Status
  status          String   @default("pending") // pending, scheduled, in_progress, completed, failed, no_answer, voicemail, cancelled
  outcome         String?  // confirmed, reschedule_requested, cancelled, booking_requested, patient_ok, callback_requested
  
  // Scheduling
  scheduled_for   DateTime
  attempts        Int      @default(0)
  max_attempts    Int      @default(3)
  last_attempt_at DateTime?
  completed_at    DateTime?
  
  // Response tracking
  dtmf_response   String?  // DTMF digit pressed
  notes           String?  @db.Text
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  // Relations
  clinic          clinic      @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  patient         patient     @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  appointment     appointment? @relation(fields: [appointment_id], references: [id], onDelete: SetNull)

  @@index([clinic_id])
  @@index([patient_id])
  @@index([appointment_id])
  @@index([status])
  @@index([scheduled_for])
  @@index([call_type])
}
